<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebAudio Test</title>
    <meta name="description" content="WebAudio Test">
    <meta name="author" content="Simon Guest">
    <script src="./lib/blockly.min.js"></script>
    <!-- link rel="stylesheet" href="css/styles.css?v=1.0"-->
</head>

<body>
<h1>WebAudio and Blockly</h1>
<div id="workspace" style="height: 480px; width: 800px;"></div>
<button id="play">Play</button>
<button id="pause">Pause</button>
<button id="resume">Resume</button>
<button id="stop">Stop</button>
<button id="debug">Debug</button>
<button id="clear">Clear Session</button>

<script type="module">
    const createCustomBlock = (name, blockType) => {
        Blockly.Blocks[name] = blockType;
        Blockly.JavaScript[name] = blockType["transpile"];
    }

    import * as control from "./blocks/control";
    import * as percussion from "./blocks/percussion";
    import * as looping from "./blocks/looping";
    import {toolbox} from "./blocks/toolbox.js";

    createCustomBlock("track", control.track);
    createCustomBlock("playNote", control.playNote);
    createCustomBlock("playSample", control.playSample);
    createCustomBlock("sleep", control.sleep);
    createCustomBlock("volume", control.volume);
    createCustomBlock("filter", control.filter);
    createCustomBlock("snare", percussion.snare);
    createCustomBlock("kick", percussion.kick);
    createCustomBlock("hihat", percussion.hihat);
    createCustomBlock("techno", looping.techno);

    let workspace = Blockly.inject('workspace', {toolbox: toolbox});
    workspace.addChangeListener((ev) => {
        if ((ev.type === Blockly.Events.BLOCK_MOVE) || (ev.type === Blockly.Events.BLOCK_CHANGE) || (ev.type === Blockly.Events.BLOCK_DELETE)) {
            console.log("Writing workspace to session storage");
            let json = Blockly.serialization.workspaces.save(workspace);
            sessionStorage.setItem("workspace", JSON.stringify(json));
        }
    });

    const loadFile = async (filename) => {
        const response = await fetch(filename);
        if (!response.ok) {
            console.error(`HTTP Error: ${response.status}`);
        }
        return await response.arrayBuffer();
    }

    const loadSamples = async (audioContext, filenames) => {
        return new Promise((resolve) => {
            let samples = new Map();
            filenames.forEach(async (filename) => {
                let buffer = await loadFile(filename);
                let decodedBuffer = await audioContext.decodeAudioData(buffer);
                let sampleName = /.+\/(.*).wav/.exec(filename)[1];
                samples.set(sampleName, decodedBuffer);
                console.log(`Added ${sampleName} to audio samples.`);
            });
            resolve(samples);
        });
    }

    const convertToUnitInterval = (value) => {
        // Convert value to fixed point between 0 and 1 for the WebAudio API
        value = Math.abs(value);
        if (value > 100) value = 100;
        return value / 100;
    }

    const playSample = (context, samples, name, options) => {
        options = typeof options !== 'undefined' ? options : {};
        let offset = options.offset || 0;
        let volume = options.volume || 100;
        let filter = options.filter || 100;

        let src = context.createBufferSource();
        src.buffer = samples.get(name);
        console.log(src);

        var gainNode = context.createGain();
        gainNode.gain.value = convertToUnitInterval(volume);
        gainNode.connect(context.destination);

        var filterNode = context.createBiquadFilter();
        filterNode.type = "lowpass";
        var hz = (src.buffer.sampleRate / 4) * convertToUnitInterval(filter);
        filterNode.frequency.value = hz;
        console.log(filterNode);
        filterNode.connect(gainNode);

        src.connect(filterNode);

        src.start(offset + context.currentTime);

        return src.buffer.duration; // useful to cue up other samples
    }

    const playNote = (context, note, timeOffset, duration, volume) => {
        let osc = context.createOscillator();
        osc.type = "sine";
        osc.frequency.value = note;
        console.log(osc);

        var nextNode = context.createGain();
        nextNode.connect(context.destination);
        nextNode.gain.value = convertToUnitInterval(volume);
        osc.connect(nextNode);

        osc.start(context.currentTime + timeOffset);
        osc.stop(context.currentTime + timeOffset + duration);
    }

    const playDebugClip = (context, samples, tempo) => {
        playNote(context, 261.625565300598634, 0, 0.5);
    }

    async function start() {
        console.log("Loading workspace from session storage");
        let jsonStr = sessionStorage.getItem("workspace");
        if (jsonStr) Blockly.serialization.workspaces.load(JSON.parse(jsonStr), workspace);

        let context = new window.AudioContext();
        console.log(context);

        let samples = await loadSamples(context, ["./samples/snare.wav", "./samples/hihat.wav", "./samples/kick.wav", "./samples/techno.wav", "./samples/techno2.wav", "./samples/techno3.wav"]);
        console.log(samples);

        document.getElementById("play").onclick = () => {
            console.log("play button pressed");

            // Generate the required code
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log(code);

            context = new window.AudioContext();
            var volume = 100;
            eval(code);
        }

        document.getElementById("pause").onclick = () => {
            console.log("pause button pressed");
            context.suspend();
        }

        document.getElementById("resume").onclick = () => {
            console.log("resume button pressed");
            context.resume();
        }

        document.getElementById("stop").onclick = () => {
            console.log("stop button pressed");
            context.close();
        }

        document.getElementById("debug").onclick = () => {
            console.log("debug button pressed");
            context = new window.AudioContext();
            playSample(context, samples, "snare", {});
            playSample(context, samples, "snare", { offset: 0.5 });
        }

        document.getElementById("clear").onclick = () => {
            console.log("clear session button pressed");
            sessionStorage.removeItem("workspace");
        }

    }

    start();
</script>
</body>

</html>